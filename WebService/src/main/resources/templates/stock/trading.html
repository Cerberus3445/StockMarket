<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Демо-Трейдинг</title>
    <link rel="stylesheet" type="text/css" href="../../static/css/style.css" th:href="@{/css/style.css}">
    <link rel="stylesheet" type="text/css" href="../../static/css/stock.css" th:href="@{/css/stock.css}">
</head>
<body>
<h1>Инструмент для торговли:</h1>
<div class="chart">
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text"></span></a></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
            {
                "width": "980",
                "height": "800",
                "symbol": "NASDAQ:AAPL",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "allow_symbol_change": true,
                "calendar": false,
                "support_host": "https://www.tradingview.com"
            }
        </script>
    </div>
</div>

<div class="profile-info">
    <div class="container-lg">
        <div class="row mt-3">
            <div class="col-sm-3">

                <div class="card w-100">
                    <div class="card-header">
                        Profile
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="customer-profile-name">.</h5>
                        <div class="row mt-3">
                            <div class="col" style="width: 60%; flex:none">
                                <strong>Available Balance</strong>
                            </div>
                            <div class="col" style="width: 40%;" id="customer-available-balance">
                                $0
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col" style="width: 60%; flex:none">
                                <strong>Portfolio Value</strong>
                            </div>
                            <div class="col " style="width: 40%;" id="customer-portfolio-value">
                                $0
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-sm-9">

                <div class="card w-100">
                    <div class="card-header">
                        Portfolio
                    </div>
                    <div class="card-body">

                        <table class="table" id="customer-portfolio">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Stock</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Current Value</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>

                    </div>
                </div>

            </div>
            <div id="alerts" class="mt-3">

            </div>


        </div>
</div>

    <script>

        // get customer id
        const params = new URLSearchParams(window.location.search);
        const customerId = params.get('userId');
        let stockPrices = {};
        let customerPortfolioValue = {};
        console.log(customerId);

        // elements
        const customerProfileNameElement = document.getElementById('customer-profile-name');
        const customerPortfolioValueElement = document.getElementById('customer-portfolio-value');
        const customerAvailableBalanceElement = document.getElementById('customer-available-balance');
        const customerPortfolioContainer = document.getElementById('customer-portfolio').querySelector('tbody');

        // get customer information & portfolio
        const fetchCustomerInformation = async () => {
            const response = await fetch(`/api/stocks/userbalance/1`);
            const customer = await response.json();
            customerProfileNameElement.innerText = customer.name;
            customerAvailableBalanceElement.innerText = `$${customer.balance}`;
            while(customerPortfolioContainer.firstChild){
                customerPortfolioContainer.removeChild(customerPortfolioContainer.firstChild);
            }
            customer.holdings.map((holding, index) => getPortfolioRow(holding, index)).forEach((holding) => customerPortfolioContainer.append(holding));
            customer.holdings.forEach(holding => customerPortfolioValue[holding.ticker] = (holding.quantity * getStockPriceFromCache(holding.ticker)));
            customerPortfolioValue['BALANCE'] = customer.balance;
            console.log(customerPortfolioValue);
            updateCustomerPortfolioDisplayValue();
        }

        const updateCustomerPortfolioDisplayValue = () => {
            const sum = Object.values(customerPortfolioValue).reduce((acc, val) => acc + val, 0);
            if(sum >= 10000){
                customerPortfolioValueElement.innerHTML = `<p class="text-success">$${sum}</p>`;
            }else{
                customerPortfolioValueElement.innerHTML = `<p class="text-danger">$${sum}</p>`;
            }
        };

        const getPortfolioRow = (holding, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                            <th scope="row">${index + 1}</th>
                            <td>${holding.ticker}</td>
                            <td id="customer-quantity-${holding.ticker}">${holding.quantity}</td>
                            <td id="customer-value-${holding.ticker}">$${holding.quantity * getStockPriceFromCache(holding.ticker) }</td>
            `;
            return tr;
        }

        const getStockPriceFromCache = (ticker) => {
            return stockPrices[ticker] ? stockPrices[ticker] : 0;
        }

        // trigger these functions on page load
        document.addEventListener("DOMContentLoaded", () => {
            stockPriceUpdates();
            fetchCustomerInformation();
        });



    </script>

</div>
</body>
</html>